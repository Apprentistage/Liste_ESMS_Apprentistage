<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Carte interactive</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
      crossorigin=""
    />
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
      }
      #sidebar {
        width: 320px;
        height: 100vh;
        overflow-y: auto;
        padding: 16px;
        border-right: 2px solid #ccc;
        background-color: #f9f9f9;
        box-sizing: border-box;
        box-shadow: 2px 0 6px rgba(0, 0, 0, 0.1);
      }
      #sidebar h2 {
        margin-top: 0;
        font-size: 20px;
      }
      #filter-container {
        margin-bottom: 16px;
      }
      #structure-list {
        max-height: calc(100vh - 260px);
        overflow-y: auto;
      }
      .structure-item {
        padding: 12px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        transition: background 0.2s;
      }
      .structure-item:hover {
        background-color: #ececec;
      }
      .structure-item.selected {
        background-color: #a0c8ff;
        font-weight: bold;
      }
      .structure-item h4 {
        margin: 0 0 6px;
        font-size: 16px;
        color: #333;
      }
      .structure-item p {
        margin: 2px 0;
        font-size: 14px;
        color: #555;
      }
      #map {
        flex: 1;
      }
      button {
        cursor: pointer;
        padding: 6px 12px;
        font-size: 14px;
      }
      select,
      input[type="text"] {
        width: 100%;
        margin-bottom: 8px;
        padding: 4px;
        box-sizing: border-box;
      }
      #legend {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        border: 1px solid #ccc;
        padding: 10px;
        font-size: 14px;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        line-height: 1.6;
        border-radius: 6px;
      }
      .color-box {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 6px;
        border: 1px solid #444;
        vertical-align: middle;
      }

      /* Param√®tres */
      #settings-toggle {
        margin-top: 8px;
        cursor: pointer;
        font-weight: bold;
        padding: 4px;
        border-radius: 4px;
        background-color: #f2f2f2;
      }
      #settings-toggle:hover {
        background-color: #e0e0e0;
      }
      #settings-panel {
        display: none; /* cach√© au d√©part */
        margin-top: 6px;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: #fafafa;
        font-size: 14px;
      }

      /* Mode sombre uniquement sidebar + l√©gende */
      .dark-sidebar #sidebar {
        background-color: #2c2c2c;
        color: #eee;
        border-right: 2px solid #444;
      }
      .dark-sidebar #sidebar h2 {
        color: #fff;
      }
      .dark-sidebar #filter-container label {
        color: #ddd;
      }
      .dark-sidebar select,
      .dark-sidebar input[type="text"],
      .dark-sidebar button {
        background-color: #3a3a3a;
        color: #eee;
        border: 1px solid #555;
      }
      .dark-sidebar select:hover,
      .dark-sidebar input[type="text"]:hover,
      .dark-sidebar button:hover {
        background-color: #505050;
      }
      .dark-sidebar .structure-item {
        background-color: #3a3a3a;
        color: #ddd;
        border-bottom: 1px solid #555;
      }
      .dark-sidebar .structure-item:hover {
        background-color: #505050;
      }
      .dark-sidebar .structure-item h4 {
        color: #fff;
      }
      .dark-sidebar .structure-item p {
        color: #ccc;
      }
      .dark-sidebar #legend {
        background: #2c2c2c;
        color: #eee;
        border: 1px solid #444;
      }
      .dark-sidebar #settings-toggle {
        background-color: #3a3a3a;
        color: #eee;
      }
      .dark-sidebar #settings-toggle:hover {
        background-color: #505050;
      }
      .dark-sidebar #settings-panel {
        background-color: #3a3a3a;
        border: 1px solid #555;
        color: #eee;
      }
    </style>
  </head>

  <body>
    <div id="sidebar">
      <h2>Liste des √©tablissements sociaux et m√©dico-sociaux du Cher</h2>
      <div id="filter-container">
        <label for="thematique-filter">Filtrer par th√©matique :</label>
        <select id="thematique-filter">
          <option value="all" selected>Toutes</option>
          <option value="Handicap">Handicap</option>
          <option value="Protection de l enfance">
            Protection de l'enfance
          </option>
          <option value="Protection judiciaire de la jeunesse">
            Protection judiciaire de la jeunesse
          </option>
          <option value="Insertion">Insertion</option>
          <option value="Personnes agees">Personnes √¢g√©es</option>
          <option value="Services aide a la personne">
            Services d'aide √† la personne
          </option>
        </select>

        <label for="type-filter">Filtrer par type de structure :</label>
        <select id="type-filter">
          <option value="all" selected>Tous</option>
        </select>

        <!-- üîé Barre de recherche -->
        <label for="search-bar">Rechercher :</label>
        <input
          type="text"
          id="search-bar"
          placeholder="Nom, ville ou structure..."
        />

        <button id="reset-filter">R√©initialiser</button>
      </div>

      <div id="structure-list"></div>
    </div>

    <div id="map">
      <div id="legend">
        <strong>L√©gende :</strong><br />
        <span
          ><span class="color-box" style="background-color: yellow"></span>
          Handicap</span
        ><br />
        <span
          ><span class="color-box" style="background-color: blue"></span>
          Protection de l'enfance / PJJ</span
        ><br />
        <span
          ><span class="color-box" style="background-color: orange"></span>
          Insertion</span
        ><br />
        <span
          ><span class="color-box" style="background-color: green"></span>
          Personnes √¢g√©es</span
        ><br />
        <span
          ><span class="color-box" style="background-color: pink"></span>
          Services d'aide √† la personne</span
        ><br />

        <!-- ‚öôÔ∏è Param√®tres -->
        <div id="settings-toggle">‚öôÔ∏è Param√®tres</div>
        <div id="settings-panel">
          <label>
            <input type="checkbox" id="dark-mode-toggle" />
            Activation du mode sombre
          </label>
        </div>
      </div>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
      crossorigin=""
    ></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

    <script>
      let map;
      let markers = [];
      let structures = [];
      let selectedStructureId = null;
      let selectedMarker = null;

      const listEl = document.getElementById("structure-list");
      const filterSelect = document.getElementById("thematique-filter");
      const typeSelect = document.getElementById("type-filter");
      const resetBtn = document.getElementById("reset-filter");
      const searchInput = document.getElementById("search-bar");

      const settingsToggle = document.getElementById("settings-toggle");
      const settingsPanel = document.getElementById("settings-panel");
      const darkToggle = document.getElementById("dark-mode-toggle");

      const colors = {
        Handicap: "yellow",
        "Protection de l enfance": "blue",
        "Protection judiciaire de la jeunesse": "blue",
        Insertion: "orange",
        "Personnes agees": "green",
        "Services aide a la personne": "pink",
      };

      // Gestion param√®tres
      settingsToggle.addEventListener("click", () => {
        settingsPanel.style.display =
          settingsPanel.style.display === "block" ? "none" : "block";
      });

      darkToggle.addEventListener("change", () => {
        document.body.classList.toggle("dark-sidebar", darkToggle.checked);
      });

      function createMarker(structure) {
        if (!structure.Latitude || !structure.Longitude) return null;

        // Ajout du jitter si plusieurs points ont exactement la m√™me coordonn√©e
        const jitterAmount = 0.0003; // ajustable, ~30m environ
        const jitterLat =
          structure.Latitude + (Math.random() - 0.5) * jitterAmount;
        const jitterLng =
          structure.Longitude + (Math.random() - 0.5) * jitterAmount;

        const color = colors[structure.Thematique] || "gray";
        const marker = L.circleMarker([jitterLat, jitterLng], {
          radius: 10,
          fillColor: color,
          color: "#333",
          weight: 1.5,
          opacity: 1,
          fillOpacity: 0.8,
        });

        marker._id = structure._id;

        marker.on("click", () => {
          selectedStructureId = structure._id;
          markers.forEach((m) => {
            m.setRadius(10);
            m.setStyle({
              fillColor: colors[structures[m._id].Thematique] || "gray",
              color: "#333",
              weight: 1.5,
            });
          });
          marker.setRadius(18);
          marker.setStyle({ color: "red", weight: 4 });
          selectedMarker = marker;
          renderStructureList(currentFilteredStructures);
          listEl.scrollTop = 0;
          map.panTo([jitterLat, jitterLng]);
        });

        return marker;
      }

      let currentFilteredStructures = [];

      function renderStructureList(list = structures) {
        currentFilteredStructures = list;
        let sortedStructures =
          selectedStructureId !== null
            ? [
                ...list.filter((s) => s._id === selectedStructureId),
                ...list.filter((s) => s._id !== selectedStructureId),
              ]
            : [...list];

        listEl.innerHTML = "";
        sortedStructures.forEach((s) => {
          const item = document.createElement("div");
          item.className = "structure-item";
          if (s._id === selectedStructureId) item.classList.add("selected");

          item.innerHTML = `
            <h4>${s["Type structure"]} - ${s["Nom association"]}</h4>
            <p>üìç ${s.Adresse}, ${s["Code postal"]}, ${s.Ville}</p>
            <p>üìß <a href="mailto:${s.Mail}">${s.Mail}</a></p>
            <p>üìû ${s.Telephone}</p>`;
          item.addEventListener("click", () => {
            selectedStructureId = s._id;
            markers.forEach((m) => {
              m.setRadius(10);
              m.setStyle({
                fillColor: colors[structures[m._id].Thematique] || "gray",
                color: "#333",
                weight: 1.5,
              });
            });
            const marker = markers.find((m) => m._id === s._id);
            if (marker) {
              marker.setRadius(18);
              marker.setStyle({ color: "red", weight: 4 });
              selectedMarker = marker;
            }
            renderStructureList(currentFilteredStructures);
            map.panTo([s.Latitude, s.Longitude]);
            listEl.scrollTop = 0;
          });
          listEl.appendChild(item);
        });
      }

      function clearMarkers() {
        markers.forEach((m) => map.removeLayer(m));
        markers = [];
      }

      function showMarkers(list) {
        clearMarkers();
        list.forEach((s) => {
          const marker = createMarker(s).addTo(map);
          markers.push(marker);
        });
      }

      function filterStructures() {
        const selectedThematique = filterSelect.value;
        const selectedType = typeSelect.value;
        const searchText = searchInput.value.toLowerCase();

        let filtered = structures;
        if (selectedThematique !== "all") {
          filtered = filtered.filter(
            (s) => s.Thematique === selectedThematique
          );
        }
        if (selectedType !== "all") {
          filtered = filtered.filter(
            (s) => s["Type structure"] === selectedType
          );
        }
        if (searchText.trim() !== "") {
          filtered = filtered.filter(
            (s) =>
              s["Nom association"].toLowerCase().includes(searchText) ||
              s.Ville.toLowerCase().includes(searchText) ||
              s["Type structure"].toLowerCase().includes(searchText)
          );
        }
        renderStructureList(filtered);
        showMarkers(filtered);
      }

      function updateTypeFilterOptions() {
        const selectedThematique = filterSelect.value;
        let filteredStructures = structures;
        if (selectedThematique !== "all") {
          filteredStructures = structures.filter(
            (s) => s.Thematique === selectedThematique
          );
        }
        const typeSet = new Set(
          filteredStructures.map((s) => s["Type structure"])
        );
        typeSelect.innerHTML = "";
        const allOption = document.createElement("option");
        allOption.value = "all";
        allOption.textContent = "Tous";
        typeSelect.appendChild(allOption);
        typeSet.forEach((type) => {
          const option = document.createElement("option");
          option.value = type;
          option.textContent = type;
          typeSelect.appendChild(option);
        });
      }

      function resetFilter() {
        filterSelect.value = "all";
        updateTypeFilterOptions();
        typeSelect.value = "all";
        searchInput.value = "";
        selectedStructureId = null;
        selectedMarker = null;
        renderStructureList(structures);
        showMarkers(structures);
        map.setView([47.08, 2.4], 9);
        listEl.scrollTop = 0;
      }

      window.onload = () => {
        map = L.map("map").setView([47.08, 2.4], 9);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "¬© OpenStreetMap contributors",
        }).addTo(map);

        fetch(
          "https://docs.google.com/spreadsheets/d/e/2PACX-1vRqDosuLsPhhw_vHp3xLZQY4S2HHDRU4g9NOXP9OppgQpcG3T_6eeD2fpTL5zCjIdKL1kgeL5rIw_S6/pub?gid=0&single=true&output=csv"
        )
          .then((response) => {
            if (!response.ok) throw new Error("Erreur chargement CSV");
            return response.text();
          })
          .then((text) => {
            const results = Papa.parse(text, {
              header: true,
              skipEmptyLines: true,
            });
            structures = results.data.map((row, index) => ({
              _id: index,
              Thematique: row.Thematique,
              "Type structure": row["Type structure"],
              "Nom association": row["Nom association"],
              Adresse: row.Adresse,
              "Code postal": row["Code postal"],
              Ville: row.Ville,
              Mail: row.Mail,
              Telephone: row.Telephone,
              Latitude: parseFloat(row.Latitude),
              Longitude: parseFloat(row.Longitude),
            }));
            updateTypeFilterOptions();
            renderStructureList(structures);
            showMarkers(structures);
            currentFilteredStructures = structures;
          })
          .catch((err) => console.error(err));

        filterSelect.addEventListener("change", () => {
          updateTypeFilterOptions();
          filterStructures();
        });
        typeSelect.addEventListener("change", filterStructures);
        searchInput.addEventListener("input", filterStructures);
        resetBtn.addEventListener("click", resetFilter);
      };
    </script>
  </body>
</html>
